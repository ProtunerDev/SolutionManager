{% extends "layout.html" %}
{% block content %}
<div class="card">
    <div class="card-header">
        <h3>Add Solution</h3>
    </div>
    <div class="card-body">
        <!-- File Upload Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Upload Binary Files</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">ORI1 File</div>
                            <div class="card-body">
                                <form method="POST" enctype="multipart/form-data" action="{{ url_for('main.upload_file') }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="file_type" value="ori1">
                                    <div class="mb-3">
                                        <label for="ori1File" class="form-label">Select ORI1 File</label>
                                        <input class="form-control" type="file" id="ori1File" name="file" 
                                               accept=".ori,.mod,.bin" required>
                                        <div class="form-text">Accepted formats: .ori, .mod, .bin</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Upload</button>
                                </form>
                                {% if session.get('files') and session['files'].get('ori1') %}
                                <div class="alert alert-success mt-3">
                                    ORI1 file uploaded
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">MOD1 File</div>
                            <div class="card-body">
                                <form method="POST" enctype="multipart/form-data" action="{{ url_for('main.upload_file') }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="file_type" value="mod1">
                                    <div class="mb-3">
                                        <label for="mod1File" class="form-label">Select MOD1 File</label>
                                        <input class="form-control" type="file" id="mod1File" name="file" 
                                               accept=".ori,.mod,.bin" required>
                                        <div class="form-text">Accepted formats: .ori, .mod, .bin</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Upload</button>
                                </form>
                                {% if session.get('files') and session['files'].get('mod1') %}
                                <div class="alert alert-success mt-3">
                                    MOD1 file uploaded
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    {% if session.get('files') and session['files'].get('ori1') and session['files'].get('mod1') %}
                    <form method="POST" action="{{ url_for('main.compare_files') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="bitSize" class="form-label">Bit Size</label>
                            <select class="form-select" id="bitSize" name="bit_size">
                                <option value="8">8-bit</option>
                                <option value="16">16-bit</option>
                                <option value="32">32-bit</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Compare Files</button>
                    </form>
                    {% else %}
                    <div class="alert alert-info">
                        Please upload both ORI1 and MOD1 files to compare them.
                    </div>
                    {% endif %}
                </div>
                
                {% if session.get('differences') %}
                <div class="mt-3">
                    <div class="alert alert-success">
                        <strong>Files compared successfully!</strong> {{ session.differences|length }} differences found.
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Solution Information Section -->
        <form method="POST" action="{{ url_for('main.add_solution') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Search A -->
            <div class="row">
                <div class="col-md-2 mb-3">
                    <label for="vehicle_type" class="form-label">Vehicle Type</label>
                    <select class="form-select" id="vehicle_type" name="vehicle_type">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="make" class="form-label">Make</label>
                    <select class="form-select" id="make" name="make">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="model" class="form-label">Model</label>
                    <select class="form-select" id="model" name="model">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="engine" class="form-label">Engine</label>
                    <select class="form-select" id="engine" name="engine">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="ecu_type" class="form-label">ECU Type</label>
                    <select class="form-select" id="ecu_type" name="ecu_type">
                        <option value="">-- Select --</option>
                        <!-- options populated by JS -->
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="transmission_type" class="form-label">Transmission Type</label>
                    <select class="form-select" id="transmission_type" name="transmission_type">
                        <option value="">-- Select --</option>
                        <option value="Automatic">Automatic</option>
                        <option value="Manual">Manual</option>
                    </select>
                </div>
            </div>

            <!-- Search B -->
            <div class="row">
                <div class="col-md-2 mb-3">
                    <label for="hardware_number" class="form-label">Hardware Number</label>
                    <input id="hardware_number" name="hardware_number" class="form-control">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="software_number" class="form-label">Software Number</label>
                    <input id="software_number" name="software_number" class="form-control">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="software_update_number" class="form-label">Software Update Number</label>
                    <input id="software_update_number" name="software_update_number" class="form-control">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="year" class="form-label">Year</label>
                    <input type="number" id="year" name="year" class="form-control" min="1996" max="2100" required>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-12">
                    <h4>Solution Types</h4>
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stage_1" name="stage_1">
                                <label class="form-check-label" for="stage_1">Stage 1</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stage_2" name="stage_2">
                                <label class="form-check-label" for="stage_2">Stage 2</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pop_and_bangs" name="pop_and_bangs">
                                <label class="form-check-label" for="pop_and_bangs">Pop and Bangs</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="vmax" name="vmax">
                                <label class="form-check-label" for="vmax">Vmax</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="dtc_off" name="dtc_off">
                                <label class="form-check-label" for="dtc_off">DTC Off</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="full_decat" name="full_decat">
                                <label class="form-check-label" for="full_decat">Full Decat</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="immo_off" name="immo_off">
                                <label class="form-check-label" for="immo_off">Immo Off</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="evap_off" name="evap_off">
                                <label class="form-check-label" for="evap_off">Evap Off</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="tva" name="tva">
                                <label class="form-check-label" for="tva">TVA</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="egr_off" name="egr_off">
                                <label class="form-check-label" for="egr_off">EGR Off</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="dpf_off" name="dpf_off">
                                <label class="form-check-label" for="dpf_off">DPF Off</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="egr_dpf_off" name="egr_dpf_off">
                                <label class="form-check-label" for="egr_dpf_off">EGR + DPF Off</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="adblue_off" name="adblue_off">
                                <label class="form-check-label" for="adblue_off">AdBlue Off</label>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="egr_dpf_adblue_off" name="egr_dpf_adblue_off">
                                <label class="form-check-label" for="egr_dpf_adblue_off">EGR + DPF + AdBlue Off</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                {% if session.differences_file %}
                <button type="submit" class="btn btn-primary">Save Solution</button>
                {% else %}
                <button type="button" class="btn btn-primary disabled" disabled>Save Solution</button>
                <small class="text-muted ms-2">Please upload and compare files first</small>
                {% endif %}
                <a href="{{ url_for('main.solutions') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
