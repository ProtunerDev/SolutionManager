{% extends "layout.html" %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-home"></i> Home Dashboard</h2>
            <div class="text-muted">
                <i class="fas fa-clock"></i> Real-time view
            </div>
        </div>
    </div>
</div>

<!-- Search and Controls Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="search" class="form-label">
                            <i class="fas fa-search"></i> Search Solutions
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="search" 
                               name="search" 
                               value="{{ search_query or '' }}"
                               placeholder="Search by vehicle, make, model, engine, hardware, software, or description...">
                    </div>
                    <div class="col-md-3">
                        <label for="limit" class="form-label">
                            <i class="fas fa-list-ol"></i> Show Results
                        </label>
                        <select class="form-select" id="limit" name="limit">
                            <option value="10"{{ ' selected' if limit == 10 else '' }}>10 solutions</option>
                            <option value="20"{{ ' selected' if limit == 20 else '' }}>20 solutions</option>
                            <option value="50"{{ ' selected' if limit == 50 else '' }}>50 solutions</option>
                            <option value="100"{{ ' selected' if limit == 100 else '' }}>100 solutions</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Results Summary -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-database"></i> Recent Solutions
                {{ '- Search: "' + search_query + '"' if search_query else '' }}
            </h4>
            <span class="badge bg-info fs-6">{{ total_shown or 0 }} solutions shown</span>
        </div>
    </div>
</div>

<!-- Solutions Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {{ recent_solutions|length if recent_solutions else 0 }}
                {%- if recent_solutions -%}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col"><i class="fas fa-hashtag"></i> ID</th>
                                <th scope="col"><i class="fas fa-car"></i> Vehicle Info</th>
                                <th scope="col"><i class="fas fa-microchip"></i> Hardware/Software</th>
                                <th scope="col"><i class="fas fa-wrench"></i> Solution Types</th>
                                <th scope="col"><i class="fas fa-calendar-plus"></i> Created</th>
                                <th scope="col"><i class="fas fa-calendar-edit"></i> Last Modified</th>
                                <th scope="col"><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {%- for solution in recent_solutions -%}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">#{{ solution.id }}</span>
                                </td>
                                <td>
                                    <div class="small">
                                        <strong>{{ solution.make }} {{ solution.model }}</strong><br>
                                        <span class="text-muted">
                                            {{ solution.vehicle_type }} | {{ solution.engine }} | {{ solution.year }}
                                        </span>
                                        {%- if solution.ecu_type -%}
                                        <br><span class="badge bg-info small">{{ solution.ecu_type }}</span>
                                        {%- endif -%}
                                    </div>
                                </td>
                                <td>
                                    <div class="small">
                                        <strong>HW:</strong> {{ solution.hardware_number }}<br>
                                        <strong>SW:</strong> {{ solution.software_number }}
                                    </div>
                                </td>
                                <td>
                                    <div class="small">
                                        {%- if solution.active_types -%}
                                            {%- for type_name in solution.active_types[:3] -%}
                                                <span class="badge bg-success small me-1">{{ type_name }}</span>
                                            {%- endfor -%}
                                            {%- if solution.active_types|length > 3 -%}
                                                <span class="badge bg-warning small">+{{ solution.active_types|length - 3 }} more</span>
                                            {%- endif -%}
                                        {%- else -%}
                                            <span class="text-muted">No types specified</span>
                                        {%- endif -%}
                                    </div>
                                </td>
                                <td>
                                    <div class="small">
                                        <i class="fas fa-clock text-muted"></i>
                                        {{ solution.created_at.strftime('%m/%d/%Y') }}<br>
                                        <span class="text-muted">{{ solution.created_at.strftime('%H:%M') }}</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="small">
                                        {%- if solution.updated_at and solution.updated_at != solution.created_at -%}
                                            <i class="fas fa-edit text-warning"></i>
                                            {{ solution.updated_at.strftime('%m/%d/%Y') }}<br>
                                            <span class="text-muted">{{ solution.updated_at.strftime('%H:%M') }}</span>
                                        {%- else -%}
                                            <span class="text-muted">No changes</span>
                                        {%- endif -%}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group-vertical" role="group">
                                        <a href="{{ url_for('main.solution_detail', solution_id=solution.id) }}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                        <a href="{{ url_for('main.edit_solution', solution_id=solution.id) }}" 
                                           class="btn btn-outline-warning btn-sm">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <button type="button" 
                                                class="btn btn-outline-danger btn-sm"
                                                onclick="deleteSolutionFromHome({{ solution.id }})">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {%- endfor -%}
                        </tbody>
                    </table>
                </div>
                {%- else -%}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Solutions Found</h4>
                    {%- if search_query -%}
                    <p class="text-muted">No solutions match your search criteria: "{{ search_query }}"</p>
                    <a href="{{ url_for('main.home') }}" class="btn btn-outline-primary">
                        <i class="fas fa-times"></i> Clear Search
                    </a>
                    {%- else -%}
                    <p class="text-muted">No solutions have been added yet.</p>
                    <a href="{{ url_for('main.add_solution') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add First Solution
                    </a>
                    {%- endif -%}
                </div>
                {%- endif -%}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
                <div class="row">
                    <div class="col-md-3">
                        <a href="{{ url_for('main.add_solution') }}" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-plus-circle"></i><br>
                            Add New Solution
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('main.modify_file') }}" class="btn btn-info w-100 mb-2">
                            <i class="fas fa-file-code"></i><br>
                            Modify File
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('main.solutions') }}" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-database"></i><br>
                            Browse All Solutions
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('main.home', limit=100) }}" class="btn btn-secondary w-100 mb-2">
                            <i class="fas fa-list"></i><br>
                            Show More Results
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Auto-refresh every 5 minutes
    setTimeout(function() {
        location.reload();
    }, 300000);
    
    // Focus search input if no search query
    {% if search_query %}
    var hasSearchQuery = true;
    {% else %}
    var hasSearchQuery = false;
    {% endif %}
    
    if (!hasSearchQuery) {
        $('#search').focus();
    }
    
    // Handle real-time search (optional)
    let searchTimer;
    $('#search').on('input', function() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(function() {
            // Could implement live search here if desired
        }, 1000);
    });
});

function deleteSolutionFromHome(solutionId) {
    if (confirm('Are you sure you want to delete this solution? This action cannot be undone and will also delete all associated files.')) {
        // Disable the delete button to prevent multiple clicks
        const deleteBtn = event.target;
        const originalText = deleteBtn.innerHTML;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        
        fetch('/delete_solution_from_home', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                solution_id: solutionId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Find and remove the row from the table
                const row = deleteBtn.closest('tr');
                if (row) {
                    row.style.transition = 'opacity 0.3s ease';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        // Update the solutions count
                        const countElement = document.querySelector('.badge.bg-info');
                        if (countElement) {
                            const currentText = countElement.textContent;
                            const currentCount = parseInt(currentText.match(/\d+/)[0]);
                            const newCount = Math.max(0, currentCount - 1);
                            countElement.textContent = `${newCount} solutions shown`;
                        }
                        // Check if no more solutions and show empty message
                        const tbody = document.querySelector('.table tbody');
                        if (tbody && tbody.children.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No solutions found</td></tr>';
                        }
                    }, 300);
                }
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> Solution deleted successfully
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.main-content').insertBefore(alertDiv, document.querySelector('.main-content').firstChild);
                
                // Auto-hide the alert after 3 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            } else {
                // Re-enable the button on error
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
                alert('Error deleting solution: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Re-enable the button on error
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalText;
            alert('Error deleting solution. Please try again.');
        });
    }
}
</script>
{% endblock %}
